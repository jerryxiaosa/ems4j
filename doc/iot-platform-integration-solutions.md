# IoT平台对接方案

## 1. 概述

EMS4J平台提供了两种不同的IoT设备对接方案，以适应不同的业务场景和技术需求：

1. **设备直连（自有平台）**：内置IoT模块处理协议接入和设备管理
2. **第三方IoT平台对接**：通过适配器模式集成外部IoT平台

## 3. 设备直连（自有平台）

### 3.1 架构概览

```
+----------+    协议处理    +------------+    业务逻辑    +------------+
|  设备    |------------->|  ems-iot   |------------->| ems-business|
|          |              |  模块      |              |  模块       |
|  (TCP/   |              |            |              |            |
|   UDP/   |              |            |              |            |
|   串口)   |              |            |              |            |
+----------+              +------------+              +------------+
                              |
                              v
                       +------------+
                       |  ems-iot   |
                       |  协议处理器  |
                       +------------+
```

### 3.2 实现组件

- **协议接入层**：处理网络连接和协议解析
- **设备处理器**：实现特定设备通信协议
- **命令调度**：管理命令发送和ACK处理
- **事件发布**：向业务模块发布设备事件

### 3.3 关键特性

- **多协议支持**：基于Netty的动态协议处理
- **连接管理**：通道会话管理和串行队列
- **ACK处理**：命令确认和超时处理
- **设备标识映射**：跨系统的统一设备标识

### 3.4 实施步骤

1. **协议分析**：分析设备通信协议规范
2. **处理器开发**：在`ems-iot`中实现协议特定处理器
3. **消息解析**：解析传入数据包并转换为业务对象
4. **事件发布**：通过消息向业务模块发布事件
5. **命令转换**：将业务命令转换为设备特定协议

### 3.5 最佳实践

- 遵循分层架构：api → application → domain → infrastructure → plugins
- 实现适当的异常处理以防止连接断开
- 使用通道隔离处理多连接场景
- 在系统中维护一致的设备标识映射

## 4. 第三方IoT平台集成

### 4.1 架构概览

```
+----------+    平台集成    +-------------------+    适配器模式    +------------+
|  设备    |<------------->| ems-foundation-   |<------------->| ems-business|
|          |   (API/同步)  |  integration      |              |  模块       |
|  (多种   |               |                   |              |            |
|   厂商)   |               |  平台适配器       |              |            |
+----------+               +-------------------+              +------------+
                              |
                              v
                       +------------------+
                       |  EnergyService   |
                       |  接口            |
                       +------------------+
```

### 4.2 实现组件

- **平台适配器**：针对不同IoT平台的具体实现
- **EnergyService接口**：能源数据访问的标准接口
- **设备同步**：平台间设备数据同步
- **命令转发**：向外部平台转发命令

### 4.3 关键特性

- **适配器模式**：可插拔的平台集成
- **标准接口**：统一的`EnergyService`用于所有平台交互
- **数据同步**：双向数据同步能力
- **命令代理**：透明地将命令转发到外部平台

### 4.4 实施步骤

1. **平台分析**：研究第三方平台API规范
2. **适配器开发**：实现平台特定的适配器类
3. **接口实现**：实现`EnergyService`接口方法
4. **配置设置**：配置平台连接参数
5. **数据映射**：将平台特定数据结构映射到内部模型

### 4.5 最佳实践

- 实现`EnergyService`接口以确保行为一致性
- 使用配置驱动的平台切换（真实vs模拟）
- 实现适当的错误处理和重试机制
- 维护平台间的数据一致性