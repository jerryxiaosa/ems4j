# ems-business-account 模块文档

## 1. 模块概述

`ems-business-account` 是账户管理核心模块，负责用电账户的全生命周期管理，包括开户、销户、账户信息维护、余额预警等功能。

## 2. 核心功能

| 功能 | 说明 |
|------|------|
| 开户 | 创建用电账户，绑定业主、电表、计费方案 |
| 销户 | 账户注销，余额清算，解绑电表 |
| 账户查询 | 分页查询、详情查询、按业主查询 |
| 余额预警 | 低余额预警、欠费预警 |
| 账户充值 | 通过订单模块进行充值 |

## 3. Service 类说明

### 3.1 AccountManagerService

账户业务管理核心服务，负责开户、销户等核心业务操作。

**主要方法：**

| 方法 | 说明 |
|------|------|
| `openAccount()` | 开户 |
| `closeAccount()` | 销户 |
| `updateAccount()` | 更新账户信息 |
| `bindMeter()` | 绑定电表 |
| `unbindMeter()` | 解绑电表 |
| `getTerminationInfo()` | 获取销户结算信息 |

### 3.2 AccountInfoService

账户信息查询服务。

**主要方法：**

| 方法 | 说明 |
|------|------|
| `getDetail()` | 获取账户详情 |
| `findPage()` | 分页查询账户 |
| `findByOwnerId()` | 按业主查询账户 |
| `getAccountWithMeters()` | 获取账户及关联电表 |

### 3.3 AccountBalanceAlertService

账户余额预警服务。

**主要方法：**

| 方法 | 说明 |
|------|------|
| `checkBalanceAlert()` | 检查余额预警 |
| `sendAlert()` | 发送预警通知 |

## 4. 模块依赖关系

```
+---------------------------+
|   ems-business-account    |
+---------------------------+
            |
            | 依赖
            v
+---------------------------+     +---------------------------+
|   ems-business-device     |     |   ems-business-finance    |
| (电表管理服务)             |     | (余额、订单、消费服务)      |
+---------------------------+     +---------------------------+
            |                               |
            v                               v
+---------------------------+     +---------------------------+
|   ems-business-plan       |     | ems-foundation-user       |
|  (电价方案、预警方案)       |     |     (用户服务)            |
+---------------------------+     +---------------------------+
                                            |
                                            v
                                  +---------------------------+
                                  | ems-foundation-organization|
                                  |     (组织服务)             |
                                  +---------------------------+
            |
            v
+---------------------------+     +---------------------------+
| ems-components-datasource |     |   ems-components-lock     |
+---------------------------+     +---------------------------+
            |
            v
+---------------------------+
|       ems-common          |
+---------------------------+
```

## 5. Service 内部依赖

### 5.1 AccountManagerServiceImpl 依赖

```
+-------------------------------------+
|     AccountManagerServiceImpl       |
+-------------------------------------+
                |
    +-----------+-----------+-----------+
    |           |           |           |
    v           v           v           v
+-------+  +--------+  +---------+  +--------+
|本模块  |  |device  |  | finance |  | plan   |
|Service|  | 模块    |  |  模块   |  |  模块   |
+-------+  +--------+  +---------+  +--------+
    |           |           |           |
    v           v           v           v
+------------------+  +------------------+  +------------------+
|AccountInfoService|  |ElectricMeter     |  | BalanceService   |
+------------------+  |  ManagerService  |  +------------------+
                      +------------------+  | OrderService     |
                      |ElectricMeterInfo |  +------------------+
                      |    Service       |  |AccountConsume    |
                      +------------------+  |    Service       |
                                            +------------------+
    |
    v
+------------------+     +------------------+
|  foundation      |     |   components     |
+------------------+     +------------------+
|OrganizationServ. |     | LockTemplate     |
+------------------+     +------------------+
                         | RequestContext   |
                         +------------------+
```

## 6. 数据实体

| 实体 | 说明 |
|------|------|
| `AccountEntity` | 账户主表 |
| `AccountCancelRecordEntity` | 销户记录 |

## 7. 关键业务流程

### 7.1 开户流程

```
openAccount(OpenAccountDto)
        |
        v
+-------+-------+
| 1. 获取分布式锁 |
| (按业主锁定)   |
+-------+-------+
        |
        v
+-------+-------+
| 2. 校验业主信息 |
| (组织服务)     |
+-------+-------+
        |
        v
+-------+-------+
| 3. 创建账户记录 |
+-------+-------+
        |
        v
+-------+-------+
| 4. 绑定电表    |
| (开表操作)     |
+-------+-------+
        |
        v
+-------+-------+
| 5. 初始化余额  |
| (BalanceServ.) |
+-------+-------+
        |
        v
+-------+-------+
| 6. 设置预警方案 |
| (WarnPlanServ.)|
+-------+-------+
        |
        v
+-------+-------+
| 7. 释放锁      |
+-------+-------+
```

### 7.2 销户流程

```
closeAccount(CloseAccountDto)
        |
        v
+-------+-------+
| 1. 获取分布式锁 |
+-------+-------+
        |
        v
+-------+-------+
| 2. 校验账户状态 |
| (是否可销户)   |
+-------+-------+
        |
        v
+-------+-------+
| 3. 计算结算金额 |
| (MeterConsume  |
|    Service)    |
+-------+-------+
        |
        v
+-------+-------+
| 4. 创建结算订单 |
| (OrderService) |
+-------+-------+
        |
        v
+-------+-------+
| 5. 余额清算    |
| (退款/清零)    |
+-------+-------+
        |
        v
+-------+-------+
| 6. 解绑电表    |
| (销表操作)     |
+-------+-------+
        |
        v
+-------+-------+
| 7. 更新账户状态 |
| (已销户)       |
+-------+-------+
        |
        v
+-------+-------+
| 8. 记录销户日志 |
+-------+-------+
```

## 8. 账户类型

| 类型 | 说明 |
|------|------|
| `PREPAID` | 预付费账户（先充值后用电） |
| `POSTPAID` | 后付费账户（先用电后结算） |

## 9. 分布式锁说明

模块使用 Redisson 分布式锁保证并发安全：

| 锁 Key | 说明 |
|--------|------|
| `LOCK:OWNER:{ownerType}:{ownerId}` | 业主级别锁，防止同一业主并发开户 |
| `LOCK:ACCOUNT:{accountId}` | 账户级别锁，防止同一账户并发操作 |
