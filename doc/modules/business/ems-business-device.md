# ems-business-device 模块文档

## 1. 模块概述

`ems-business-device` 是设备管理核心模块，负责电表和网关的全生命周期管理，包括设备档案、状态控制、开表/销表等业务功能。

## 2. 核心功能

| 功能 | 说明 |
|------|------|
| 电表管理 | 电表记录 CRUD、开表、销表 |
| 网关管理 | 网关记录 CRUD、网关下挂电表管理 |
| 状态控制 | 合闸/分闸、功率限制、强制控制 |
| 状态同步 | 设备在线状态同步、电量数据同步 |
| 设备查询 | 分页查询、条件筛选、详情查询 |

## 3. 模块依赖关系

```
+---------------------------+
|   ems-business-device     |
+---------------------------+
            |
            | 依赖
            v
+---------------------------+     +---------------------------+
|   ems-business-plan       |     |   ems-business-finance    |
| (电价方案、预警方案)        |---->| (余额服务、消费记录)        |
+---------------------------+     +---------------------------+
            |                               |
            v                               v
+---------------------------+     +---------------------------+
| ems-foundation-integration|     |   ems-foundation-space    |
| (设备命令、能源数据)        |     |     (空间/区域管理)        |
+---------------------------+     +---------------------------+
            |
            v
+---------------------------+
|   ems-foundation-system   |
|      (系统配置)            |
+---------------------------+
            |
            v
+---------------------------+
| ems-components-datasource |
+---------------------------+
            |
            v
+---------------------------+
|       ems-common          |
+---------------------------+
```

## 4. Service 内部依赖

### 4.1 ElectricMeterManagerServiceImpl 依赖

```
+-------------------------------------+
|   ElectricMeterManagerServiceImpl   |
+-------------------------------------+
                |
    +-----------+-----------+
    |           |           |
    v           v           v
+-------+  +--------+  +---------+
|本模块  |  |finance |  |  plan   |
|Service|  | 模块    |  |  模块   |
+-------+  +--------+  +---------+
    |           |           |
    v           v           v
+------------------+  +------------------+  +------------------+
|ElectricMeterInfo |  | BalanceService   |  |ElectricPricePlan |
|    Service       |  |                  |  |    Service       |
+------------------+  +------------------+  +------------------+
| GatewayService   |  |MeterConsumeServ. |  | WarnPlanService  |
+------------------+  +------------------+  +------------------+
    |
    v
+------------------+     +------------------+     +------------------+
|  foundation      |     |  foundation      |     |  foundation      |
| -integration     |     |    -space        |     |    -system       |
+------------------+     +------------------+     +------------------+
| DeviceCommand    |     |  SpaceService    |     |  ConfigService   |
|    Service       |     |                  |     |                  |
+------------------+     +------------------+     +------------------+
| EnergyService    |
| DeviceModelServ. |
| DeviceModuleCtx  |
+------------------+
```

## 5. 关键业务流程

### 5.1 开表流程（`openMeterAccount`）

该流程由 `ElectricMeterManagerServiceImpl.openMeterAccount` 驱动，核心是“绑定账户 + 下发方案 + 建立计量基线”，整体在事务中执行。

| 步骤 | 核心动作 | 关键校验/规则 | 失败处理 |
|------|----------|---------------|----------|
| 1 | 参数与电表状态校验 | 按量账户必须有电价方案和预警方案；输入电表必须全部存在；电表必须未开户、预付费、在线 | 抛业务异常，流程终止 |
| 2 | 初始化电表账户关系 | 逐表写入 `accountId`；按量账户初始化电表余额 | 抛业务异常，事务回滚 |
| 3 | 配置电表方案 | 按量账户配置电价和预警方案；包月账户开启保电模式 | 抛业务异常，事务回滚 |
| 4 | 批量计算并写入预警等级 | 基于余额阈值分组计算 `NONE/FIRST/SECOND` 并批量更新 | 抛业务异常，事务回滚 |
| 5 | 建立开户计量基线 | 保存开表记录、阶梯起点记录、初始电量记录（初始记录时间顺延 1 秒） | 抛业务异常，事务回滚 |
| 6 | 返回结果并结束 | 返回开表完成状态 | 主流程结束 |

补充说明：

- 阶梯记录会先清理旧 `is_latest`，再写入新年度起点，避免同表多条“当前记录”。
- 若开启“继承历史电量”，仅在历史记录年度与当前年度一致时继承偏移量。

### 5.2 合闸/分闸流程（`setSwitchStatus`）

该流程由 `ElectricMeterManagerServiceImpl.setSwitchStatus` 驱动，采用“先落目标状态，再下发命令”的执行模型。

| 步骤 | 核心动作 | 关键校验/规则 | 失败处理 |
|------|----------|---------------|----------|
| 1 | 校验电表可操作性 | 电表必须存在、已同步 IoT、且在线 | 抛业务异常，流程终止 |
| 2 | 写入目标开关状态 | 根据目标状态更新 `is_cut_off` | 数据库更新异常抛出 |
| 3 | 构建设备命令 | 按目标状态映射 `ENERGY_ELECTRIC_TURN_ON/OFF`，生成命令数据 | 参数不合法抛业务异常 |
| 4 | 保存并执行命令 | 调用 `DeviceCommandService` 保存命令并执行下发 | 执行失败抛业务异常 |
| 5 | 记录操作日志 | 记录原状态、目标状态、命令信息 | 日志失败不影响主流程 |

补充说明：

- 无论数据库当前状态与目标状态是否一致，都会执行下发命令，避免设备状态漂移后无法纠正。
- 失败时可结合命令记录进行重试或人工排障。

### 5.3 销表流程（`cancelMeterAccount`）

该流程由 `ElectricMeterManagerServiceImpl.cancelMeterAccount` 驱动，支持批量销表，核心是“逐表结算 + 统一解绑”。

| 步骤 | 核心动作 | 关键校验/规则 | 失败处理 |
|------|----------|---------------|----------|
| 1 | 遍历处理每块电表 | 为每块电表构建详情并进入销表子流程 | 任一电表失败时整体失败 |
| 2 | 生成销表电量记录 | 在线电表读取实时电量；离线电表要求人工传入分时电量 | 缺少离线电量输入抛业务异常 |
| 3 | 查询销表余额 | 按量账户读取电表余额；非按量账户余额为空 | 余额读取异常抛业务异常 |
| 4 | 计算历史阶梯累计电量 | 使用“当前总电量 - 阶梯起点 + 历史偏移”，并保护不小于 0 | 计算异常抛业务异常 |
| 5 | 写入销表记录 | 持久化 `MeterCancelRecord`（余额、电量、空间路径等） | 抛业务异常，事务回滚 |
| 6 | 批量清理账户绑定 | 统一清空电表 `accountId` 及相关账户字段 | 抛业务异常，事务回滚 |
| 7 | 返回销表结果列表 | 返回每块电表的余额与历史累计电量 | 上层继续执行账户销户清算 |

补充说明：

- 该方法为账户销户流程提供输入（每块电表的清算基础数据）。
- 批量销表在同一事务内执行，保证“记录写入”和“解绑关系”一致性。
