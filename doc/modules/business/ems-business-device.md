# ems-business-device 模块文档

## 1. 模块概述

`ems-business-device` 是设备管理核心模块，负责电表和网关的全生命周期管理，包括设备档案、状态控制、开表/销表等业务功能。

## 2. 核心功能

| 功能 | 说明                 |
|------|--------------------|
| 电表管理 | 电表记录 CRUD、开表、销表 |
| 网关管理 | 网关记录 CRUD、网关下挂电表管理 |
| 状态控制 | 合闸/分闸、功率限制、强制控制    |
| 状态同步 | 设备在线状态同步、电量数据同步    |
| 设备查询 | 分页查询、条件筛选、详情查询     |

## 3. Service 类说明

### 3.1 ElectricMeterManagerService

电表管理核心服务，提供电表的增删改、状态控制、计费管理等功能。

**主要方法：**

| 方法 | 说明 |
|------|------|
| `addMeter()` | 新增电表 |
| `updateMeter()` | 更新电表信息 |
| `deleteMeter()` | 删除电表 |
| `openMeter()` | 开表（绑定账户） |
| `cancelMeter()` | 销表（解绑账户） |
| `switchOn()` | 合闸 |
| `switchOff()` | 分闸 |
| `setPowerLimit()` | 设置功率限制 |

### 3.2 ElectricMeterInfoService

电表信息查询服务。

**主要方法：**

| 方法 | 说明 |
|------|------|
| `getDetail()` | 获取电表详情 |
| `findPage()` | 分页查询电表 |
| `findByAccountId()` | 按账户查询电表 |

### 3.3 GatewayService

网关管理服务。

**主要方法：**

| 方法 | 说明 |
|------|------|
| `addGateway()` | 新增网关 |
| `updateGateway()` | 更新网关信息 |
| `deleteGateway()` | 删除网关 |
| `getDetail()` | 获取网关详情 |
| `findPage()` | 分页查询网关 |

## 4. 模块依赖关系

```
+---------------------------+
|   ems-business-device     |
+---------------------------+
            |
            | 依赖
            v
+---------------------------+     +---------------------------+
|   ems-business-plan       |     |   ems-business-finance    |
| (电价方案、预警方案)        |---->| (余额服务、消费记录)        |
+---------------------------+     +---------------------------+
            |                               |
            v                               v
+---------------------------+     +---------------------------+
| ems-foundation-integration|     |   ems-foundation-space    |
| (设备命令、能源数据)        |     |     (空间/区域管理)        |
+---------------------------+     +---------------------------+
            |
            v
+---------------------------+
|   ems-foundation-system   |
|      (系统配置)            |
+---------------------------+
            |
            v
+---------------------------+
| ems-components-datasource |
+---------------------------+
            |
            v
+---------------------------+
|       ems-common          |
+---------------------------+
```

## 5. Service 内部依赖

### 5.1 ElectricMeterManagerServiceImpl 依赖

```
+-------------------------------------+
|   ElectricMeterManagerServiceImpl   |
+-------------------------------------+
                |
    +-----------+-----------+
    |           |           |
    v           v           v
+-------+  +--------+  +---------+
|本模块  |  |finance |  |  plan   |
|Service|  | 模块    |  |  模块   |
+-------+  +--------+  +---------+
    |           |           |
    v           v           v
+------------------+  +------------------+  +------------------+
|ElectricMeterInfo |  | BalanceService   |  |ElectricPricePlan |
|    Service       |  |                  |  |    Service       |
+------------------+  +------------------+  +------------------+
| GatewayService   |  |MeterConsumeServ. |  | WarnPlanService  |
+------------------+  +------------------+  +------------------+
    |
    v
+------------------+     +------------------+     +------------------+
|  foundation      |     |  foundation      |     |  foundation      |
| -integration     |     |    -space        |     |    -system       |
+------------------+     +------------------+     +------------------+
| DeviceCommand    |     |  SpaceService    |     |  ConfigService   |
|    Service       |     |                  |     |                  |
+------------------+     +------------------+     +------------------+
| EnergyService    |
| DeviceModelServ. |
| DeviceModuleCtx  |
+------------------+
```

## 6. 数据实体

| 实体 | 说明 |
|------|------|
| `ElectricMeterEntity` | 电表主表 |
| `OpenMeterEntity` | 开表记录 |
| `MeterCancelRecordEntity` | 销表记录 |
| `MeterStepEntity` | 电表阶梯配置 |
| `GatewayEntity` | 网关表 |

## 7. 关键业务流程

### 7.1 开表流程

```
openMeter(OpenMeterDto)
        |
        v
+-------+-------+
| 1. 校验电表状态 |
| (未开表/可用)  |
+-------+-------+
        |
        v
+-------+-------+
| 2. 获取设备信息 |
| (IoT平台同步)  |
+-------+-------+
        |
        v
+-------+-------+
| 3. 初始化余额  |
| (BalanceServ.) |
+-------+-------+
        |
        v
+-------+-------+
| 4. 绑定计费方案 |
| (PlanService)  |
+-------+-------+
        |
        v
+-------+-------+
| 5. 更新电表状态 |
| (已开表)       |
+-------+-------+
        |
        v
+-------+-------+
| 6. 记录开表日志 |
+-------+-------+
```

### 7.2 合闸/分闸流程

```
switchOn/switchOff(meterId)
        |
        v
+-------+-------+
| 1. 校验电表状态 |
+-------+-------+
        |
        v
+-------+-------+
| 2. 创建命令记录 |
| (DeviceCommand |
|    Service)    |
+-------+-------+
        |
        v
+-------+-------+
| 3. 下发设备命令 |
| (EnergyService)|
+-------+-------+
        |
        v
+-------+-------+
| 4. 更新电表状态 |
+-------+-------+
```

### 7.3 销表流程

```
cancelMeter(CancelMeterDto)
        |
        v
+-------+-------+
| 1. 校验电表状态 |
| (已开表/可用)  |
+-------+-------+
        |
        v
+-------+-------+
| 2. 检查账户余额 |
| (是否为0或负数)  |
+-------+-------+
        |
        v
+-------+-------+
| 3. 创建销表记录 |
| (MeterCancelRec.|
|    Repository)  |
+-------+-------+
        |
        v
+-------+-------+
| 4. 更新电表状态 |
| (已销表)       |
+-------+-------+
        |
        v
+-------+-------+
| 5. 解绑关联账户 |
+-------+-------+
        |
        v
+-------+-------+
| 6. 记录销表日志 |
+-------+-------+
```

## 8. 配置项

| 配置 | 说明 |
|------|------|
| `useRealDevice` | 是否对接真实设备（true: 真实设备，false: 模拟数据） |
