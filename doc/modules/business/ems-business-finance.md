# ems-business-finance 模块文档

## 1. 模块概述

`ems-business-finance` 是财务核算核心模块，负责余额管理、订单处理、电量消费计算、金额扣费等财务相关功能。

## 2. 核心功能

| 功能 | 说明 |
|------|------|
| 余额管理 | 账户余额查询、充值、扣费、冻结 |
| 订单管理 | 充值订单、结算订单、订单支付 |
| 电量消费 | 抄表数据处理、电量差值计算、按费率计费 |
| 账户消费 | 账户级消费汇总、月度消费统计 |
| 补正管理 | 电量补正、金额补正 |

## 3. Service 类说明

### 3.1 BalanceService

余额管理服务，处理账户/电表余额的增减操作。

**主要方法：**

| 方法 | 说明 |
|------|------|
| `getBalance()` | 查询余额 |
| `recharge()` | 充值 |
| `deduct()` | 扣费 |
| `freeze()` | 冻结余额 |
| `unfreeze()` | 解冻余额 |
| `transfer()` | 余额转移 |

### 3.2 OrderService

订单服务，处理充值、结算等订单业务。

**主要方法：**

| 方法 | 说明 |
|------|------|
| `createRechargeOrder()` | 创建充值订单 |
| `createSettlementOrder()` | 创建结算订单 |
| `payOrder()` | 订单支付 |
| `cancelOrder()` | 取消订单 |
| `getOrderDetail()` | 查询订单详情 |

### 3.3 MeterConsumeService

电表消费服务，处理电量消费计算和记录。

**主要方法：**

| 方法 | 说明 |
|------|------|
| `saveMeterPowerRecord()` | 保存抄表数据 |
| `calculateConsume()` | 计算消费金额 |
| `findConsumeRecords()` | 查询消费记录 |
| `getMonthlyConsume()` | 获取月度消费 |

### 3.4 MeterCorrectionService

电量补正服务。

**主要方法：**

| 方法 | 说明 |
|------|------|
| `addCorrection()` | 添加补正记录 |
| `applyCorrection()` | 应用补正 |

### 3.5 AccountConsumeService

账户消费服务，处理账户级消费汇总。

**主要方法：**

| 方法 | 说明 |
|------|------|
| `getAccountConsume()` | 获取账户消费汇总 |
| `getMonthlyConsume()` | 获取月度消费统计 |

### 3.6 ServiceRateService

服务费率服务。

**主要方法：**

| 方法 | 说明 |
|------|------|
| `getServiceRate()` | 获取服务费率 |

## 4. 模块依赖关系

```
+---------------------------+
|   ems-business-finance    |
+---------------------------+
            |
            | 依赖
            v
+---------------------------+
|   ems-business-plan       |
| (电价方案服务)             |
+---------------------------+
            |
            v
+---------------------------+     +---------------------------+
| ems-foundation-space      |     | ems-foundation-organization|
|   (空间服务)               |     |     (组织服务)             |
+---------------------------+     +---------------------------+
            |                               |
            v                               v
+---------------------------+     +---------------------------+
| ems-foundation-system     |     |     ems-mq-api            |
|   (系统配置)               |     |   (消息队列)              |
+---------------------------+     +---------------------------+
            |
            v
+---------------------------+     +---------------------------+
| ems-components-datasource |     |   ems-components-lock     |
+---------------------------+     +---------------------------+
            |
            v
+---------------------------+
|       ems-common          |
+---------------------------+
```

## 5. Service 内部依赖

### 5.1 MeterConsumeServiceImpl 依赖

```
+-------------------------------------+
|      MeterConsumeServiceImpl        |
+-------------------------------------+
                |
    +-----------+-----------+
    |           |           |
    v           v           v
+-------+  +--------+  +---------+
|本模块  |  |  plan  |  |foundation|
|Service|  |  模块   |  |   模块   |
+-------+  +--------+  +---------+
    |           |           |
    v           v           v
+------------------+  +------------------+  +------------------+
| BalanceService   |  |ElectricPricePlan |  |  SpaceService    |
+------------------+  |    Service       |  +------------------+
                      +------------------+  |OrganizationServ. |
                                            +------------------+
    |
    v
+------------------+
|   components     |
+------------------+
| LockTemplate     |
+------------------+
| RequestContext   |
+------------------+
```

### 5.2 OrderServiceImpl 依赖

```
+-------------------------------------+
|         OrderServiceImpl            |
+-------------------------------------+
                |
    +-----------+-----------+
    |           |           |
    v           v           v
+-------+  +--------+  +---------+
|本模块  |  |foundation|  |  mq    |
|Service|  |   模块   |  |  模块   |
+-------+  +---------+  +---------+
    |           |           |
    v           v           v
+------------------+  +------------------+  +------------------+
| BalanceService   |  |OrganizationServ. |  | MQ Publisher     |
+------------------+  +------------------+  +------------------+
|ServiceRateService|
+------------------+
|OrderCheckService |
+------------------+
|OrderQueryService |
+------------------+
```

## 6. 数据实体

| 实体 | 说明 |
|------|------|
| `BalanceEntity` | 余额表 |
| `BalanceRecordEntity` | 余额变动记录 |
| `OrderEntity` | 订单表 |
| `ElectricMeterPowerRecordEntity` | 电表抄表记录 |
| `ElectricMeterPowerConsumeRecordEntity` | 电量消费记录 |
| `ElectricMeterBalanceConsumeRecordEntity` | 金额消费记录 |
| `ElectricMeterPowerRelationEntity` | 电量关联记录 |

## 7. 关键业务流程

### 7.1 电量消费流程

```
saveMeterPowerRecord(MeterPowerRecordDto)
        |
        v
+-------+-------+
| 1. 获取分布式锁 |
| (按电表锁定)   |
+-------+-------+
        |
        v
+-------+-------+
| 2. 查询上次抄表 |
+-------+-------+
        |
        v
+-------+-------+
| 3. 计算电量差值 |
| (本次-上次)    |
+-------+-------+
        |
        v
+-------+-------+
| 4. 获取电价方案 |
| (PlanService)  |
+-------+-------+
        |
        v
+-------+-------+
| 5. 按时段计算费用|
| (尖/峰/平/谷)  |
+-------+-------+
        |
        v
+-------+-------+
| 6. 扣减账户余额 |
| (BalanceServ.) |
+-------+-------+
        |
        v
+-------+-------+
| 7. 记录消费流水 |
+-------+-------+
        |
        v
+-------+-------+
| 8. 检查余额预警 |
+-------+-------+
```

### 7.2 充值订单流程

```
createRechargeOrder(RechargeOrderDto)
        |
        v
+-------+-------+
| 1. 校验账户状态 |
+-------+-------+
        |
        v
+-------+-------+
| 2. 计算服务费  |
| (ServiceRate)  |
+-------+-------+
        |
        v
+-------+-------+
| 3. 创建订单记录 |
| (待支付状态)   |
+-------+-------+
        |
        v
+-------+-------+
| 4. 返回支付信息 |
+-------+-------+

payOrder(PayOrderDto)
        |
        v
+-------+-------+
| 1. 校验订单状态 |
+-------+-------+
        |
        v
+-------+-------+
| 2. 处理支付回调 |
| (微信支付等)   |
+-------+-------+
        |
        v
+-------+-------+
| 3. 账户充值    |
| (BalanceServ.) |
+-------+-------+
        |
        v
+-------+-------+
| 4. 更新订单状态 |
| (已支付)       |
+-------+-------+
```

## 8. 分布式锁说明

| 锁 Key | 说明 |
|--------|------|
| `LOCK:METER:{meterId}` | 电表级别锁，防止同一电表并发消费计算 |

## 9. 消费类型

| 类型 | 说明 |
|------|------|
| `NORMAL` | 正常消费 |
| `CORRECTION` | 补正消费 |
| `SETTLEMENT` | 结算消费 |

## 10. 支付渠道

| 渠道 | 说明 |
|------|------|
| `WECHAT` | 微信支付 |
| `CASH` | 现金 |
| `TRANSFER` | 转账 |
