# ems-business-finance 模块文档

## 1. 模块概述

`ems-business-finance` 是财务核算核心模块，负责余额管理、订单处理、电量消费计算、金额扣费等财务相关功能。

## 2. 核心功能

| 功能 | 说明 |
|------|------|
| 余额管理 | 账户/电表余额初始化、充值、扣费、查询 |
| 订单管理 | 订单创建、支付回调处理、完结/关闭、状态广播 |
| 电量消费 | 抄表数据落库、分时电量差值计算、金额消费计算 |
| 账户消费 | 包月扣费、账户级消费记录 |
| 补正管理 | 电量补正、金额补正 |

## 3. 模块依赖关系

```
+---------------------------+
|   ems-business-finance    |
+---------------------------+
            |
            | 依赖
            v
+---------------------------+
|   ems-business-plan       |
| (电价方案服务)             |
+---------------------------+
            |
            v
+---------------------------+     +---------------------------+
| ems-foundation-space      |     | ems-foundation-organization|
|   (空间服务)               |     |     (组织服务)             |
+---------------------------+     +---------------------------+
            |                               |
            v                               v
+---------------------------+     +---------------------------+
| ems-foundation-system     |     |     ems-mq-api            |
|   (系统配置)               |     |   (消息队列)              |
+---------------------------+     +---------------------------+
            |
            v
+---------------------------+     +---------------------------+
| ems-components-datasource |     |   ems-components-lock     |
+---------------------------+     +---------------------------+
            |
            v
+---------------------------+
|       ems-common          |
+---------------------------+
```

## 4. Service 内部依赖

### 4.1 MeterConsumeServiceImpl 依赖

```
+-------------------------------------+
|      MeterConsumeServiceImpl        |
+-------------------------------------+
                |
    +-----------+-----------+
    |           |           |
    v           v           v
+-------+  +--------+  +---------+
|本模块  |  |  plan  |  |foundation|
|Service|  |  模块   |  |   模块   |
+-------+  +--------+  +---------+
    |           |           |
    v           v           v
+------------------+  +------------------+  +------------------+
| BalanceService   |  |ElectricPricePlan |  |  SpaceService    |
+------------------+  |    Service       |  +------------------+
                      +------------------+  |OrganizationServ. |
                                            +------------------+
    |
    v
+------------------+
|   components     |
+------------------+
| LockTemplate     |
+------------------+
| RequestContext   |
+------------------+
```

### 4.2 OrderServiceImpl 依赖

```
+-------------------------------------+
|         OrderServiceImpl            |
+-------------------------------------+
                |
    +-----------+-----------+
    |           |           |
    v           v           v
+-------+  +--------+  +---------+
|本模块  |  |foundation|  |  mq    |
|Service|  |   模块   |  |  模块   |
+-------+  +---------+  +---------+
    |           |           |
    v           v           v
+------------------+  +------------------+  +------------------+
| OrderCreation    |  | LockTemplate     |  | MqService        |
| Handler集合      |  +------------------+  +------------------+
+------------------+
| OrderCompletion  |
| Handler集合      |
+------------------+
| OrderThirdParty  |
| Handler集合      |
+------------------+
```

## 5. 关键业务流程

### 5.1 抄表消费流程（`MeterConsumeServiceImpl.savePowerRecord`）

该流程核心是“记录抄表数据 -> 计算电量差值 -> 计算金额 -> 扣减余额”，按电表粒度加锁执行。

| 步骤 | 核心动作 | 关键校验/规则 | 失败处理 |
|------|----------|---------------|----------|
| 1 | 获取电表锁 `LOCK:METER:{meterId}` | 同一电表消费计算串行化 | 加锁失败抛业务异常，稍后重试 |
| 2 | 保存抄表记录与关系记录 | 先落 `power_record`，再落 `power_relation` | 任一落库失败抛异常并回滚 |
| 3 | 判断是否仅落库不计费 | `needConsume=false` 时跳过后续计算 | 直接结束流程 |
| 4 | 选取消费起始记录 | 优先基于最近消费记录；首次上报或异常时跳过计算 | 找不到有效起始记录则结束 |
| 5 | 计算分时电量差值并生成消费记录 | 计算总/尖峰平谷深谷差值 | 差值为负时标记 `isCalculate=false` 并跳过扣费 |
| 6 | 判断是否需要扣费 | 非预付费、未开户、包月账户均跳过金额扣费 | 仅保留电量消费记录 |
| 7 | 计算金额消费 | 读取电价方案，按阶梯倍率与分时单价计算金额 | 电价缺失则记录并跳过扣费 |
| 8 | 扣减余额并写余额消费记录 | 调用 `BalanceService.deduct`，回写期初/期末余额并保存消费流水 | 扣费失败抛异常回滚 |

补充说明：

- 电量回退/乱序不会触发扣费，但会保留消费记录用于审计。
- 阶梯电价计算异常会降级为默认倍率，避免主流程中断。

### 5.2 订单处理流程（`OrderServiceImpl`）

订单处理采用策略模式，由“创建处理器 + 三方处理器 + 完成处理器”协同完成。

| 阶段 | 核心动作 | 关键校验/规则 | 失败处理 |
|------|----------|---------------|----------|
| 创建订单（`createOrder`） | 按 `OrderCreationInfoDto` 选择创建处理器，生成订单与明细，再调用支付渠道 `onCreate` | 不支持的订单类型/支付渠道直接失败 | 抛业务异常并回滚 |
| 支付回调（`answerPayNotify`） | 三方回调转换后按订单号加锁处理，校验状态与支付金额，更新订单状态 | 已成功/已关闭订单直接幂等返回；金额不一致标记 `PAY_ERROR` | 抛业务异常并回滚 |
| 主动完结（`complete`） | 按订单号加锁，调用三方 `onCheckComplete` 校验支付，更新状态 | 支付金额异常转换为 `PAY_ERROR` | 抛业务异常并回滚 |
| 关闭订单（`close`） | 按订单号加锁，调用三方 `onClose` 后更新关闭状态 | 已关闭订单幂等返回 | 抛业务异常并回滚 |
| 状态后置动作 | 成功状态发送事务消息；非成功状态发送状态广播消息 | 成功态通过 `OrderCompletionHandler` 生成业务消息 | 消息发送失败按 MQ 机制重试 |

补充说明：

- 订单锁键为 `LOCK:ORDER:{orderSn}`，保证同一订单状态流转串行。
- 订单状态由数据库更新结果强校验（更新行数必须为 1）。

### 5.3 余额变动流程（`BalanceServiceImpl.topUp/deduct`）

余额变动核心是“幂等流水先落库 -> 原子更新余额 -> 发布余额变动事件”。

| 步骤 | 核心动作 | 关键校验/规则 | 失败处理 |
|------|----------|---------------|----------|
| 1 | 写入流水 `OrderFlowEntity` | `consumeId(orderNo)` 唯一，防止重复操作 | 重复写入抛业务异常 |
| 2 | 更新余额 | `balanceTopUp` 影响行数必须为 1 | 更新失败抛业务异常 |
| 3 | 发布余额变动事件 | 读取最新余额后发送 `BALANCE_CHANGED` 消息 | 找不到余额仅告警，不中断主流程 |
| 4 | 余额查询 | 按 `balanceRelationId + balanceType` 查询 | 未命中抛 `NotFoundException` |
| 5 | 余额初始化/删除 | 初始化时防重复；删除要求影响行数为 1 | 异常抛业务异常 |

补充说明：

- `deduct` 通过金额取负复用统一结算逻辑，减少重复分支。
- 余额事件采用 `sendMessageAfterCommit`，保证“库内成功后再发消息”。
