# ems-business-plan 模块文档

## 1. 模块概述

`ems-business-plan` 是计费方案管理模块，负责电价方案、预警方案和默认计费配置的维护，为设备侧下发和财务侧计费提供统一参数来源。

## 2. 核心功能

| 功能 | 说明 |
|------|------|
| 电价方案管理 | 电价方案 CRUD，支持自定义电价与基础电价倍率模式 |
| 默认时段管理 | 尖峰平谷深谷时间段配置维护与校验 |
| 默认电价管理 | 基础尖峰平谷电价配置维护，并联动更新非自定义方案 |
| 默认阶梯管理 | 阶梯电价配置维护（档位区间与倍率） |
| 预警方案管理 | 余额预警方案增删改查（一级/二级阈值） |

## 3. 模块依赖关系

```
+---------------------------+
|    ems-business-plan      |
+---------------------------+
            |
            | 依赖
            v
+---------------------------+
|  ems-foundation-system    |
|    (系统配置服务)          |
+---------------------------+
            |
            v
+---------------------------+
| ems-components-datasource |
+---------------------------+
            |
            v
+---------------------------+
|       ems-common          |
+---------------------------+
```

## 4. Service 内部依赖

### 4.1 ElectricPricePlanServiceImpl 依赖

```
+-------------------------------------+
|    ElectricPricePlanServiceImpl     |
+-------------------------------------+
                |
                v
+---------------------------+
|   ems-foundation-system   |
+---------------------------+
| ConfigService             |
| (读写默认时段/电价/阶梯配置)|
+---------------------------+
```

### 4.2 WarnPlanServiceImpl 依赖

```
+-------------------------------------+
|       WarnPlanServiceImpl           |
+-------------------------------------+
                |
                v
+---------------------------+
|   (无外部模块依赖)         |
|   仅依赖本模块 Repository  |
+---------------------------+
```

## 5. 关键业务流程

### 5.1 电价方案维护流程（`ElectricPricePlanServiceImpl.add/edit`）

该流程用于维护单个电价方案，核心是“实体转换 -> 价格与倍率校验 -> 唯一性校验 -> 落库”。

| 步骤 | 核心动作 | 关键校验/规则 | 失败处理 |
|------|----------|---------------|----------|
| 1 | DTO 转实体 | `add` 强制 `id=null`；`edit` 先校验原记录存在 | 原记录不存在抛异常 |
| 2 | 阶梯配置处理 | `isStep=true` 时校验阶梯档位并序列化保存 `stepPrice` | 阶梯配置不合法抛业务异常 |
| 3 | 基础电价填充（非自定义） | 从系统默认电价读取基准价，按倍率回填五档价格 | 默认配置缺失或不完整抛业务异常 |
| 4 | 方案完整性校验 | 校验倍率必填、价格计算正确、方案名称唯一 | 任一校验失败抛业务异常 |
| 5 | 持久化 | `insert` 或 `updateById` | 数据库异常抛出并回滚 |

补充说明：

- 非自定义方案必须满足“价格 = 基础价 × 倍率”。
- `getDetail` 会按 `isStep`、`isCustomPrice` 动态裁剪返回字段，避免无效字段干扰前端。

### 5.2 默认配置维护流程（`editElectricTime/editElectricPrice/editDefaultStepPrice`）

该流程用于维护系统级默认配置，配置写入 `sys_config`，并在必要时联动历史方案。

| 步骤 | 核心动作 | 关键校验/规则 | 失败处理 |
|------|----------|---------------|----------|
| 1 | 输入校验 | 按配置类型进入对应校验：时段、基础电价、阶梯电价 | 校验失败抛业务异常 |
| 2 | 配置标准化 | 时段配置排序并补齐 00:00 起点，禁止重复/连续同费率 | 标准化失败抛业务异常 |
| 3 | 写入系统配置 | 调用 `ConfigService.update` 更新目标 key | 配置 key 不存在时报错 |
| 4 | 联动更新（仅基础电价） | 更新所有 `isCustomPrice=false` 方案的基准价与实际电价 | 方案更新异常抛业务异常 |
| 5 | 返回结果 | 配置修改生效 | 上层按需重新下发设备配置 |

补充说明：

- 时段配置最多支持 14 段，不允许中间跳点。
- 基础电价必须完整覆盖 `HIGHER/HIGH/LOW/LOWER/DEEP_LOW` 五档。

### 5.3 预警方案维护流程（`WarnPlanServiceImpl.add/edit/delete`）

该流程用于维护余额预警方案，核心是“阈值规则校验 + 方案落库”。

| 步骤 | 核心动作 | 关键校验/规则 | 失败处理 |
|------|----------|---------------|----------|
| 1 | DTO 转实体 | `add` 强制 `id=null`；`edit` 先校验原记录存在 | 原记录不存在抛异常 |
| 2 | 阈值规则校验 | 一级阈值必须大于二级阈值 | 不满足规则抛业务异常 |
| 3 | 持久化 | `insert` / `updateById` / `deleteById` | 数据库异常抛出 |
| 4 | 查询返回 | `findList/getDetail` 提供方案数据给账户/设备模块使用 | 未命中时 `getDetail` 抛 `NotFoundException` |

补充说明：

- 当前预警方案不依赖外部配置中心，规则完全由本模块维护。
- 预警方案会被账户与电表开户流程引用，变更后应评估存量数据影响。
